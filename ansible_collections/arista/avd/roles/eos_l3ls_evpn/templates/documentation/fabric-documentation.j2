{% set fabric_doc = namespace() %}
{% set fabric_doc.leaf_total = 0 %}
{% for l3leaf_node_group in l3leaf.node_groups | arista.avd.natural_sort %}
{%     set fabric_doc.leaf_total = fabric_doc.leaf_total + l3leaf.node_groups[l3leaf_node_group].nodes | length %}
{% endfor %}

{% set fabric_switches = [] %}
{% set topology_links = [] %}
{% set underlay_p2p_network_summaries = [] %}
{% set overlay_loopback_network_summaries = [] %}
{% set vtep_loopback_network_summaries = [] %}
{% set assigned_ip_addresses = [] %}
{% set interfaces_done = [] %}
{% for node in groups['all'] | arista.avd.natural_sort %}
{%     if hostvars[node].type | arista.avd.default('undefined') in ['spine', 'l3leaf', 'l2leaf', 'super-spine', 'overlay-controller'] %}
{# Populate network summaries #}
{%         do underlay_p2p_network_summaries.append(underlay_p2p_network_summary) %}
{# Populate fabric_switch #}
{%         set fabric_switch = namespace() %}
{%         set fabric_switch.type = hostvars[node].type %}
{%         set fabric_switch.node = node %}
{%         set fabric_switch.mgmt_ip = hostvars[node].switch_mgmt_ip | arista.avd.default('-') %}
{%         set fabric_switch.platform = hostvars[node].switch_platform | arista.avd.default('-') %}
{%         set fabric_switch.provisioned = 'Not Available' if hostvars[node].is_deployed is arista.avd.defined(false) else 'Provisioned' %}
{%         if hostvars[node].loopback_interfaces is arista.avd.defined and hostvars[node].loopback_interfaces.Loopback0 is arista.avd.defined %}
{%             if hostvars[node].loopback_interfaces.Loopback0.ip_address is arista.avd.defined %}
{%                 set fabric_switch.loopback0_ip_address = hostvars[node].loopback_interfaces.Loopback0.ip_address %}
{%                 do assigned_ip_addresses.append(fabric_switch.loopback0_ip_address) %}
{%             endif %}
{%         endif %}
{%         if hostvars[node].loopback_interfaces is arista.avd.defined and hostvars[node].loopback_interfaces.Loopback1 is arista.avd.defined %}
{%             if hostvars[node].loopback_interfaces.Loopback1.ip_address is arista.avd.defined %}
{%                 set fabric_switch.loopback1_ip_address = hostvars[node].loopback_interfaces.Loopback1.ip_address %}
{%                 do assigned_ip_addresses.append(fabric_switch.loopback1_ip_address) %}
{%             endif %}
{%         endif %}
{%         do fabric_switches.append(fabric_switch) %}
{# #}
{%         do assigned_ip_addresses.append(hostvars[node].switch_mgmt_ip) if hostvars[node].switch_mgmt_ip is arista.avd.defined %}
{# Populate topology_links #}
{%         for ethernet_interface in hostvars[node].ethernet_interfaces | arista.avd.natural_sort %}
{%             if hostvars[node].ethernet_interfaces[ethernet_interface].peer_type | arista.avd.default('undefined') in ['spine', 'l3leaf', 'l2leaf', 'super-spine', 'overlay-controller'] %}
{%                 do interfaces_done.append(node ~ "," ~ ethernet_interface) %}
{%                 set peer = hostvars[node].ethernet_interfaces[ethernet_interface].peer %}
{%                 set peer_interface = hostvars[node].ethernet_interfaces[ethernet_interface].peer_interface %}
{%                 if peer is arista.avd.defined and peer_interface is arista.avd.defined and peer ~ "," ~ peer_interface not in interfaces_done %}
{%                     set topology_link = namespace() %}
{%                     set topology_link.type = hostvars[node].type %}
{%                     set topology_link.node = node %}
{%                     set topology_link.node_interface = ethernet_interface %}
{%                     set topology_link.node_ip_address = hostvars[node].ethernet_interfaces[ethernet_interface].ip_address %}
{%                     if topology_link.node_ip_address is arista.avd.defined %}
{%                         do assigned_ip_addresses.append(topology_link.node_ip_address) %}
{%                     endif %}
{%                     set topology_link.peer_type = hostvars[node].ethernet_interfaces[ethernet_interface].peer_type %}
{%                     set topology_link.peer = peer %}
{%                     set topology_link.peer_interface = peer_interface %}
{%                     set topology_link.peer_ip_address = none %}
{%                     if hostvars[peer] is arista.avd.defined and hostvars[peer].ethernet_interfaces is arista.avd.defined %}
{%                         if hostvars[peer].ethernet_interfaces[peer_interface] is arista.avd.defined %}
{%                             if hostvars[peer].ethernet_interfaces[peer_interface].ip_address is arista.avd.defined %}
{%                                 set topology_link.peer_ip_address = hostvars[peer].ethernet_interfaces[peer_interface].ip_address %}
{%                                 do assigned_ip_addresses.append(topology_link.peer_ip_address) %}
{%                             endif %}
{%                         endif %}
{%                     endif %}
{%                     do topology_links.append(topology_link) %}
{%                 endif %}
{%             endif %}
{%         endfor %}
{%     endif %}
{% endfor %}
{% set underlay_p2p_network_summaries = underlay_p2p_network_summaries | unique | arista.avd.natural_sort %}

# {{ fabric_name | arista.avd.default("Fabric") }}

## Table of Contents

- [{{ fabric_name | arista.avd.default("Fabric") }}](#{{ fabric_name | arista.avd.default("Fabric") | replace('_',"") | lower }} )
  - [Fabric Switches and Management IP](#fabric-switches-and-management-ip)
  - [Fabric Topology](#fabric-topology)
  - [Fabric IP Allocation](#fabric-ip-allocation)
    - [Fabric Point-To-Point Links](#fabric-point-to-point-links)
    - [Point-To-Point Links Node Allocation](#point-to-point-links-node-allocation)
    - [Overlay Loopback Interfaces (BGP EVPN Peering)](#overlay-loopback-interfaces-bgp-evpn-peering)
    - [Loopback0 Interfaces Node Allocation](#loopback0-interfaces-node-allocation)
{% if underlay_routing_protocol|lower == "isis" %}
    - [CLNS Interfaces](#isis-clns-interfaces)
{% endif %}
    - [VTEP Loopback VXLAN Tunnel Source Interfaces (Leafs Only)](#vtep-loopback-vxlan-tunnel-source-interfaces-leafs-only)
    - [VTEP Loopback Node allocation](#vtep-loopback-node-allocation)

## Fabric Switches and Management IP

| Type | Node | Management IP | Platform | Provisioned in Cloudvision |
| ---- | ---- | ------------- | -------- | -------------------------- |
{% for fabric_switch in fabric_switches %}
| {{ fabric_switch.type }} | {{ fabric_switch.node }} | {{fabric_switch.mgmt_ip }} | {{ fabric_switch.platform }} | {{ fabric_switch.provisioned }} |
{% endfor %}

> Provision status is based on Ansible inventory declaration and do not represent real status from Cloudvision.

## Fabric Topology

| Type | Node | Node Interface | Peer Type | Peer Node | Peer Interface |
| ---- | ---- | -------------- | --------- | ----------| -------------- |
{% for topology_link in topology_links %}
| {{ topology_link.type }} | {{ topology_link.node }} | {{topology_link.node_interface }} | {{ topology_link.peer_type }} | {{ topology_link.peer }} | {{ topology_link.peer_interface }} |
{% endfor %}

## Fabric IP Allocation

### Fabric Point-To-Point Links

| P2P Summary | Available Addresses | Assigned addresses | Assigned Address % |
| ----------- | ------------------- | ------------------ | ------------------ |
| {{ underlay_p2p_network_summary }} | {{ underlay_p2p_network_summary | ipaddr('size') }} | {{ spine.nodes | length * fabric_doc.leaf_total * 2 * max_l3leaf_to_spine_links }} | {{ (( spine.nodes | length * fabric_doc.leaf_total * 2 * max_l3leaf_to_spine_links ) / underlay_p2p_network_summary|ipaddr('size') * 100 ) | round(2,'ceil') }} % |

### Point-To-Point Links Node Allocation

| Node | Node Interface | Node IP Address | Peer Node | Peer Interface | Peer IP Address |
| ---- | -------------- | --------------- | --------- | -------------- | --------------- |
{% for topology_link in topology_links %}
    {% if topology_link.node_ip_address is arista.avd.defined and topology_link.peer_ip_address is arista.avd.defined %}
| {{ topology_link.node }} | {{topology_link.node_interface }} | {{ topology_link.node_ip_address }} | {{ topology_link.peer }} | {{ topology_link.peer_interface }} | {{ topology_link.peer_ip_address }} |
    {% endif %}
{% endfor %}

### Overlay Loopback Interfaces (BGP EVPN Peering)

| Overlay Loopback Summary | Available Addresses | Assigned addresses | Assigned Address % |
| ------------------------ | ------------------- | ------------------ | ------------------ |
| {{ overlay_loopback_network_summary  }} | {{ overlay_loopback_network_summary | ipaddr('size') }} | {{ spine.nodes | length + fabric_doc.leaf_total }} | {{ (( spine.nodes | length + fabric_doc.leaf_total ) / overlay_loopback_network_summary|ipaddr('size') * 100 ) | round(2,'ceil') }} % |

### Loopback0 Interfaces Node Allocation

| Node | Loopback0 |
| ---- | --------- |
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].type == "spine" %}
| {{ node }} | {{ hostvars[node].loopback_interfaces.Loopback0.ip_address }} |
{%     endif %}
{% endfor %}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%    if hostvars[node].type == "l3leaf" %}
| {{ node }} | {{ hostvars[node].loopback_interfaces.Loopback0.ip_address }} |
{%     endif %}
{% endfor %}

{% if underlay_routing_protocol|lower == "isis" %}
### ISIS CLNS interfaces

| Node | CLNS Address |
| ---- | ------------ |
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].type | arista.avd.default('undefined') in ['spine', 'l3leaf', 'super-spine', 'overlay-controller'] %}
| {{ node }} | {{ hostvars[node].router_isis.net }} |
{% endif %}
{% endfor %}

{% endif %}
### VTEP Loopback VXLAN Tunnel Source Interfaces (Leafs Only)

| VTEP Loopback Summary | Available Addresses | Assigned addresses | Assigned Address % |
| --------------------- | ------------------- | ------------------ | ------------------ |
| {{ vtep_loopback_network_summary  }} | {{ vtep_loopback_network_summary | ipaddr('size') }} | {{ fabric_doc.leaf_total }} | {{ ( fabric_doc.leaf_total / overlay_loopback_network_summary|ipaddr('size') * 100 ) | round(2,'ceil') }} % |

### VTEP Loopback Node allocation

| Node | Loopback1 |
| ---- | --------- |
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%    if hostvars[node].type == "l3leaf" %}
| {{ node }} | {{ hostvars[node].loopback_interfaces.Loopback1.ip_address }} |
{%     endif %}
{% endfor %}