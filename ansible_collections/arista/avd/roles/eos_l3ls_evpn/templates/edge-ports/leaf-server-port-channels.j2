{# Leaf server port-channels #}
{% for server in servers | arista.avd.natural_sort() %}
{%     for adapter in servers[server].adapters %}
{%         if adapter.port_channel is defined and adapter.port_channel.state == "present" %}
{%             for switch in adapter.switches %}
{%                 if switch == inventory_hostname %}
{%                     set channel_group_id = (adapter.switch_ports[0] | regex_findall("\d") | join ) %}
  Port-Channel{{ channel_group_id }}:
    description: {{ server }}_{{ adapter.port_channel.description }}
    vlans: {{ port_profiles[adapter.profile].vlans }}
    mode: {{ port_profiles[adapter.profile].mode }}
{%                 if port_profiles[adapter.profile].native_vlan is defined %}
    native_vlan: {{ port_profiles[adapter.profile].native_vlan }}
{%                 endif %}
{%                     if adapter.switches | unique | list | length > 1 and adapter.port_channel.esi is not defined %}
    mlag: {{ channel_group_id }}
{%                     endif %}
{# Add ESI Support isse aristanetworks/ansible-avd #215 #}
{%                     if adapter.switches | unique | list | length > 1 %}
{%                         if adapter.port_channel.esi is defined and adapter.port_channel.esi is not none %}
    esi: {{ adapter.port_channel.esi }}
{%                         endif %}
{%                         if adapter.port_channel.lacp_id is defined and adapter.port_channel.lapc_id is not none %}
    lacp_id: {{ adapter.port_channel.lacp_id }}
{%                         endif %}
{%                     endif %}
{%                 break %}
{%                 endif %}
{%             endfor %}
{%         endif %}
{%     endfor %}
{% endfor %}
