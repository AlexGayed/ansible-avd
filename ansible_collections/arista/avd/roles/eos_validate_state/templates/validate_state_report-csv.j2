{# AVD State Validation Report - CSV #}
Test ID,Node,Test Decription,Test,Results
{% set test_id = namespace(value=0) %}
{# Placeholder Hardware results #}
{# NTP Status Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].ntp_status_results is defined and hostvars[node].ntp_status_results.skipped is not defined %}
{%         set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},Synchronised with NTP server,NTP,{% if hostvars[node].ntp_status_results.failed == false %}PASS{% else %}FAIL{% endif %}

{%    endif %}
{% endfor %}
{# Ethernet Interface State Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].ethernet_interface_state_results is defined and hostvars[node].ethernet_interface_state_results.results is defined %}
{%         for result in hostvars[node].ethernet_interface_state_results.results %}
{%             set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},Ethernet Interface Status & Line Protocol == "up",{{ result.ethernet_interface.key }} - {{ result.ethernet_interface.value.description }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%         endfor %}
{%    endif %}
{% endfor %}
{# Port-Channel Interface State Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].port_channel_interface_state_results is defined and hostvars[node].port_channel_interface_state_results.results is defined %}
{%         for result in hostvars[node].port_channel_interface_state_results.results %}
{%             set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},Port-Channel Interface Status & Line Protocol == "up",{{ result.port_channel_interface.key }} - {{ result.port_channel_interface.value.description }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%         endfor %}
{%    endif %}
{% endfor %}
{# Vlan Interface State Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].vlan_interface_state_results is defined and hostvars[node].vlan_interface_state_results.results is defined %}
{%         for result in hostvars[node].vlan_interface_state_results.results %}
{%             set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},Vlan Interface Status & Line Protocol == "up",{{ result.vlan_interface.key }} - {{ result.vlan_interface.value.description }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%         endfor %}
{%    endif %}
{% endfor %}
{# Vxlan Interface State Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].vxlan_interface_state_results is defined and hostvars[node].vxlan_interface_state_results.skipped is not defined %}
{%         set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},Vxlan Interface Status & Line Protocol == "up",Vxlan1,{% if hostvars[node].vxlan_interface_state_results.failed == false %}PASS{% else %}FAIL{% endif %}

{%    endif %}
{% endfor %}
{# Loopback Interface State Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].loopback_interface_state_results is defined and hostvars[node].loopback_interface_state_results.results is defined %}
{%         for result in hostvars[node].loopback_interface_state_results.results %}
{%             set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},Loopback Interface Status & Line Protocol == "up",{{ result.loopback_interface.key }} - {{ result.loopback_interface.value.description }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%         endfor %}
{%    endif %}
{% endfor %}
{# LLDP Topology Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].lldp_topology_results is defined and hostvars[node].lldp_topology_results.results is defined %}
{%         for result in hostvars[node].lldp_topology_results.results %}
{%             if result.skipped is not defined %}
{%                 set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},lldp topology - validate peer and interface,{{ result.ethernet_interface.key }} - {{ result.ethernet_interface.value.description }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%             endif %}
{%         endfor %}
{%    endif %}
{% endfor %}
{# mlag_state_results Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].mlag_state_results is defined and hostvars[node].mlag_state_results.skipped is not defined %}
{%         set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},MLAG State active & Status connected,MLAG,{% if hostvars[node].mlag_state_results.failed == false %}PASS{% else %}FAIL{% endif %}

{%    endif %}
{% endfor %}
{# IP Reachability test - point-to-point links Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].ip_reachability_results is defined and hostvars[node].ip_reachability_results.results is defined %}
{%         for result in hostvars[node].ip_reachability_results.results %}
{%             if result.skipped is not defined %}
{%                 set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},ip reachability test p2p links,Source: {{ node }}_{{ result.ip_reachability_test.ethernet_interface.key }} | Destination: {{ result.ip_reachability_test.ethernet_interface.value.peer }}_{{ result.ip_reachability_test.ethernet_interface.value.peer_interface }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%             endif %}
{%         endfor %}
{%    endif %}
{% endfor %}
{# ArBGP State Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].arbgp_state_results is defined and hostvars[node].arbgp_state_results.skipped is not defined %}
{%         set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},ArBGP is configured and operating,ArBGP,{% if hostvars[node].arbgp_state_results.failed == false %}PASS{% else %}FAIL{% endif %}

{%    endif %}
{% endfor %}
{# ip bgp neighbors peer state - IPv4-UNDERLAY-PEERS Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].ip_bgp_peer_state_results is defined and hostvars[node].ip_bgp_peer_state_results.results is defined %}
{%         for result in hostvars[node].ip_bgp_peer_state_results.results %}
{%             if result.skipped is not defined %}
{%                 set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},ip bgp peer state established - IPv4-UNDERLAY-PEERS & "MLAG-IPv4-UNDERLAY-PEER,bgp_neighbor: {{ result.bgp_neighbor.key }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%             endif %}
{%         endfor %}
{%    endif %}
{% endfor %}
{# bgp evpn neighbors peer state - IPv4-UNDERLAY-PEERS Results #}
{% for node in groups[fabric_name] | arista.avd.natural_sort %}
{%     if hostvars[node].ip_bgp_peer_state_results is defined and hostvars[node].ip_bgp_peer_state_results.results is defined %}
{%         for result in hostvars[node].ip_bgp_peer_state_results.results %}
{%             if result.skipped is not defined %}
{%                 set test_id.value = test_id.value + 1 %}
{{ test_id.value }},{{ node }},bgp evpn peer state established - EVPN-OVERLAY-PEERS,bgp_neighbor: {{ result.bgp_neighbor.key }},{% if result.failed == false %}PASS{% else %}FAIL{% endif %}

{%             endif %}
{%         endfor %}
{%    endif %}
{% endfor %}