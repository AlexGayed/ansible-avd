---
- name: ENIX - Test Configlet
  hosts: cvp
  connection: local
  gather_facts: no
  collections:
    - arista.cvp
  vars:
    devices_inventory:
      veos01:
        name: veos01
        configlets:
          - veos01-basic-configuration
          - alias
          - SYS_TelemetryBuilderV2_172.23.0.2_1
          - SYS_TelemetryBuilderV2
          - ENIX_MLAG
          - ENIX_INTERFACE
    configlet_list_init:
      ENIX_MLAG: "! This is a Very First Testing Configlet\n!"
      ENIX_INTERFACE: "! This is a Very First Testing Configlet\n!"
    configlet_list_run:
      ENIX_MLAG: "{{ lookup('file', 'generated_configlets/mlag.conf') }}"
      ENIX_INTERFACE: "{{ lookup('file', 'generated_configlets/interfaces.conf') }}"

  tasks:
    - name: 'ENIX - Collecting facts from CVP {{inventory_hostname}}.'
      tags:
        - always
      cv_facts:
      register: cvp_facts

### Configure testing environment

    - name: 'ENIX - PROVISION - Create configlets on CVP {{inventory_hostname}}.'
      tags:
        - provision
      cv_configlet:
        cvp_facts: "{{cvp_facts.ansible_facts}}"
        configlets: "{{configlet_list_init}}"
        configlet_filter: ["ENIX"]
      register: cvp_configlet

    - name: 'ENIX - PROVISION - Bind Configlet to VEOS01 on CVP {{inventory_hostname}}.'
      tags: 
        - provision
      cv_device:
        devices: "{{devices_inventory}}"
        cvp_facts: '{{cvp_facts.ansible_facts}}'
        device_filter: ['veos01']
      register: cvp_device

    - name: 'ENIX - RUN - CVP configlets status on {{inventory_hostname}}'
      tags:
        - provision
      debug:
        var: cvp_configlet

### RUN test to update configlet

    - name: 'ENIX - RUN - Update configlets on CVP {{inventory_hostname}}.'
      tags:
        - run
      cv_configlet:
        cvp_facts: "{{cvp_facts.ansible_facts}}"
        configlets: "{{configlet_list_run}}"
        configlet_filter: ["ENIX"]
      register: cvp_configlet_run

    - name: 'ENIX - RUN - CVP configlets status on {{inventory_hostname}}'
      tags:
        - run
      debug:
        var: cvp_configlet_run