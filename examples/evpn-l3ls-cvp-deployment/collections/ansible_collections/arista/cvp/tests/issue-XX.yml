---
- name: Build Testing topology using Dev CVP servers
  hosts: cvp
  connection: local
  gather_facts: no
  vars:
    configlet_scale:
      ENIX_CONFIGLET01: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET02: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET03: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET04: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET05: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET06: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET07: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET08: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET09: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET10: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET11: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET12: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET13: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET14: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET15: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET16: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET17: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET18: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET19: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET20: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET21: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET23: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET24: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET25: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET26: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET27: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET28: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET29: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET30: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET31: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET32: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET33: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET34: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET35: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET36: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET37: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET38: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET39: 'alias a{{ 999 | random }} show version'
      ENIX_CONFIGLET40: 'alias a{{ 999 | random }} show version'
  ### Configuration tasks
  tasks:
    - name: '#01 - Collect initial facts with default config from {{inventory_hostname}}'
      cv_facts:
      register: FACTS

    - name: '#02 - Create configlets on CVP {{inventory_hostname}}.'
      cv_configlet:
        cvp_facts: "{{FACTS.ansible_facts}}"
        configlets: "{{configlet_scale}}"
        configlet_filter: ["ENIX_CONFIGLET"]
      register: cvp_configlet

    - name: '#03 - Collect initial facts with default config from {{inventory_hostname}}'
      cv_facts:
      register: FACTS

    - name: "#03 - Check if config key does not exists in devices"
      assert:
        that:
          - "'config' not in item"
        fail_msg: 'Config has been found in facts'
        success_msg: "Configuration is absent from facts"
        quiet: '{{quiet}}'
      with_items:
        - '{{FACTS.ansible_facts.devices}}'
      # ignore_errors: yes

    # - name: '#04 - Save FACTS to issue89.log'
    #   copy: 
    #     content: '{{ FACTS }}' 
    #     dest: 'issue89.default.log'

    - name: '#05 - Collect initial facts with gather_subset config from {{inventory_hostname}}'
      cv_facts:
        gather_subset:
          config
      register: FACTS

    - name: "#07 - Check if config key does not exists in devices"
      assert:
        that:
          - "'config' in item"
        success_msg: "Config has been found in facts"
        fail_msg: "Configuration is absent from facts"
        quiet: '{{quiet}}'
      with_items:
        - ' {{FACTS.ansible_facts.devices}} '
    #   ignore_errors: yes

    # - name: '#08 - Save FACTS to issue89.config.log'
    #   copy: 
    #     content: '{{ FACTS }}' 
    #     dest: 'issue89.config.log'